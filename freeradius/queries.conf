# Custom SQL queries for PostgreSQL with lowercase column names
# This file fixes the case-sensitivity issue with PostgreSQL

authorize_check_query = "\
	SELECT id, username, attribute, value, op \
	FROM ${authcheck_table} \
	WHERE username = '%{SQL-User-Name}' \
	ORDER BY id"

authorize_reply_query = "\
	SELECT id, username, attribute, value, op \
	FROM ${authreply_table} \
	WHERE username = '%{SQL-User-Name}' \
	ORDER BY id"

# Group queries disabled - not using groups
#authorize_group_check_query = ""
#authorize_group_reply_query = ""

accounting_onoff_query = "\
	UPDATE ${acct_table1} \
	SET \
		acctstoptime       =  TO_TIMESTAMP(%{integer:Event-Timestamp}), \
		acctsessiontime    =  ('%{integer:Event-Timestamp}' - EXTRACT(epoch FROM(acctstarttime))), \
		acctterminatecause =  '%{%{Acct-Terminate-Cause}:-NAS-Reboot}', \
		acctstopdelay      =  %{%{Acct-Delay-Time}:-0} \
	WHERE acctstoptime IS NULL \
	AND nasipaddress      =  '%{NAS-IP-Address}' \
	AND acctstarttime     <= TO_TIMESTAMP(%{integer:Event-Timestamp})"

accounting_update_query = "\
	UPDATE ${acct_table1} \
	SET \
		framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
		acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
		acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + '%{%{Acct-Input-Octets}:-0}'::bigint), \
		acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + '%{%{Acct-Output-Octets}:-0}'::bigint) \
	WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

accounting_start_query = "\
	INSERT INTO ${acct_table1} \
		(acctsessionid,		acctuniqueid,		username, \
		realm,			nasipaddress,		nasportid, \
		acctstarttime,		acctupdatetime, \
		acctstoptime,		acctsessiontime, 	acctauthentic, \
		connectinfo_start,	connectinfo_stop, 	acctinputoctets, \
		acctoutputoctets,	calledstationid, 	callingstationid, \
		acctterminatecause,	servicetype,		framedprotocol, \
		framedipaddress) \
	VALUES \
		('%{Acct-Session-Id}', \
		'%{Acct-Unique-Session-Id}', \
		'%{SQL-User-Name}', \
		'%{Realm}', \
		'%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
		'%{%{NAS-Port-ID}:-%{NAS-Port}}', \
		TO_TIMESTAMP(%{integer:Event-Timestamp}), \
		TO_TIMESTAMP(%{integer:Event-Timestamp}), \
		NULL, \
		0, \
		'%{Acct-Authentic}', \
		'%{Connect-Info}', \
		'', \
		0, \
		0, \
		'%{Called-Station-Id}', \
		'%{Calling-Station-Id}', \
		'', \
		'%{Service-Type}', \
		'%{Framed-Protocol}', \
		NULLIF('%{Framed-IP-Address}', '')::inet)"

accounting_stop_query = "\
	UPDATE ${acct_table1} SET \
		acctstoptime       = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
		acctsessiontime    = COALESCE(%{%{Acct-Session-Time}:-NULL}, \
		                     (%{integer:Event-Timestamp} - EXTRACT(epoch FROM(acctstarttime)))), \
		acctinputoctets    = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
		                     '%{%{Acct-Input-Octets}:-0}'::bigint), \
		acctoutputoctets   = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
		                     '%{%{Acct-Output-Octets}:-0}'::bigint), \
		acctterminatecause = '%{Acct-Terminate-Cause}', \
		connectinfo_stop   = '%{Connect-Info}' \
	WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

post_auth_query = "\
	INSERT INTO ${postauth_table} \
		(username, pass, reply, authdate) \
	VALUES \
		('%{User-Name}', \
		'%{%{User-Password}:-%{Chap-Password}}', \
		'%{reply:Packet-Type}', \
		NOW())"
