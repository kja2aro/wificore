# Schema-Based Multi-Tenancy Queries for FreeRADIUS
# These queries support tenant isolation by querying the correct schema based on username

# ======================
# Authorization Queries
# ======================

# Query to get user's schema from mapping table
authorize_schema_query = "\
    SELECT schema_name \
    FROM public.radius_user_schema_mapping \
    WHERE username = '%{SQL-User-Name}' \
    AND is_active = true \
    LIMIT 1"

# Query to check user credentials (schema-aware)
# This calls the PostgreSQL function that handles schema switching
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM public.radius_authorize_check('%{SQL-User-Name}')"

# Query to get user reply attributes (schema-aware)
# This calls the PostgreSQL function that handles schema switching
authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM public.radius_authorize_reply('%{SQL-User-Name}')"

# Query to get user group membership
authorize_group_check_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM radgroupcheck \
    WHERE groupname IN ( \
        SELECT groupname \
        FROM radusergroup \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority \
    ) \
    ORDER BY id"

authorize_group_reply_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM radgroupreply \
    WHERE groupname IN ( \
        SELECT groupname \
        FROM radusergroup \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority \
    ) \
    ORDER BY id"

# ======================
# Accounting Queries
# ======================

# Accounting start query (schema-aware)
accounting_start_query = "\
    INSERT INTO radacct \
    (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
     nasportid, nasporttype, acctstarttime, acctupdatetime, \
     acctsessiontime, acctauthentic, connectinfo_start, \
     calledstationid, callingstationid, servicetype, framedprotocol, \
     framedipaddress, acctstartdelay, xascendsessionsvrkey) \
    VALUES \
    ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
     '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', \
     '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
     TO_TIMESTAMP(%{integer:Event-Timestamp}), \
     TO_TIMESTAMP(%{integer:Event-Timestamp}), \
     0, '%{Acct-Authentic}', '%{Connect-Info}', \
     '%{Called-Station-Id}', '%{Calling-Station-Id}', \
     '%{Service-Type}', '%{Framed-Protocol}', \
     NULLIF('%{Framed-IP-Address}', '')::inet, \
     %{%{Acct-Delay-Time}:-0}, '%{X-Ascend-Session-Svr-Key}')"

# Accounting update query (schema-aware)
accounting_update_query = "\
    UPDATE radacct \
    SET \
        acctupdatetime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
        acctinputoctets = %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Octets}:-0}, \
        connectinfo_start = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

# Accounting stop query (schema-aware)
accounting_stop_query = "\
    UPDATE radacct \
    SET \
        acctstoptime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
        acctinputoctets = %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Octets}:-0}, \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        connectinfo_stop = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

# ======================
# Post-Auth Query
# ======================

# Post-auth query (schema-aware)
post_auth_query = "\
    INSERT INTO radpostauth \
    (username, pass, reply, authdate, class) \
    VALUES \
    ('%{SQL-User-Name}', \
     '%{%{User-Password}:-%{Chap-Password}}', \
     '%{reply:Packet-Type}', \
     NOW(), \
     '%{reply:Class}')"
