-- =========================
-- RADIUS TABLES
-- =========================
CREATE TABLE IF NOT EXISTS radcheck (
    id SERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL DEFAULT '',
    attribute VARCHAR(64) NOT NULL DEFAULT '',
    op CHAR(2) NOT NULL DEFAULT '==',
    value VARCHAR(253) NOT NULL DEFAULT ''
);
CREATE INDEX IF NOT EXISTS radcheck_username ON radcheck (username, attribute);

CREATE TABLE IF NOT EXISTS radreply (
    id SERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL DEFAULT '',
    attribute VARCHAR(64) NOT NULL DEFAULT '',
    op CHAR(2) NOT NULL DEFAULT '=',
    value VARCHAR(253) NOT NULL DEFAULT ''
);
CREATE INDEX IF NOT EXISTS radreply_username ON radreply (username, attribute);

CREATE TABLE IF NOT EXISTS radacct (
    radacctid BIGSERIAL PRIMARY KEY,
    acctsessionid VARCHAR(64) NOT NULL,
    acctuniqueid VARCHAR(32) NOT NULL UNIQUE,
    username VARCHAR(64),
    realm VARCHAR(64),
    nasipaddress INET NOT NULL,
    nasportid VARCHAR(15),
    acctstarttime TIMESTAMP WITH TIME ZONE,
    acctupdatetime TIMESTAMP WITH TIME ZONE,
    acctstoptime TIMESTAMP WITH TIME ZONE,
    acctinterval BIGINT,
    acctsessiontime BIGINT,
    acctauthentic VARCHAR(32),
    connectinfo_start VARCHAR(50),
    connectinfo_stop VARCHAR(50),
    acctinputoctets BIGINT DEFAULT 0,
    acctoutputoctets BIGINT DEFAULT 0,
    calledstationid VARCHAR(50),
    callingstationid VARCHAR(50),
    acctterminatecause VARCHAR(32),
    servicetype VARCHAR(32),
    framedprotocol VARCHAR(32),
    framedipaddress INET,
    acctstartdelay BIGINT DEFAULT 0,
    acctstopdelay BIGINT DEFAULT 0
);
CREATE INDEX IF NOT EXISTS radacct_active ON radacct (acctuniqueid) WHERE acctstoptime IS NULL;
CREATE INDEX IF NOT EXISTS radacct_start ON radacct (acctstarttime, username);

CREATE TABLE IF NOT EXISTS radpostauth (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    pass VARCHAR(64),
    reply VARCHAR(32),
    authdate TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS radpostauth_username ON radpostauth (username);

CREATE TABLE IF NOT EXISTS nas (
    id SERIAL PRIMARY KEY,
    nasname VARCHAR(128) NOT NULL UNIQUE,
    shortname VARCHAR(32),
    type VARCHAR(32) DEFAULT 'other',
    ports INTEGER,
    secret VARCHAR(60) NOT NULL,
    server VARCHAR(64),
    community VARCHAR(50),
    description VARCHAR(128)
);

CREATE INDEX IF NOT EXISTS nas_nasname ON nas (nasname);

-- =========================
-- USERS
-- =========================
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified_at TIMESTAMP,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'hotspot_user' NOT NULL, -- 'admin' or 'hotspot_user'
    phone_number VARCHAR(20) UNIQUE, -- For M-Pesa payments and user identification
    account_number VARCHAR(50) UNIQUE, -- Unique account number for payment tracking
    account_balance DECIMAL(10, 2) DEFAULT 0.00, -- User prepaid account balance
    is_active BOOLEAN DEFAULT TRUE, -- Account active status
    last_login_at TIMESTAMP, -- Last successful login timestamp
    remember_token VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT users_role_check CHECK (role IN ('admin', 'hotspot_user'))
);

-- Create indexes for faster lookups
CREATE INDEX idx_users_phone_number ON users(phone_number) WHERE phone_number IS NOT NULL;
CREATE INDEX idx_users_account_number ON users(account_number) WHERE account_number IS NOT NULL;
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);

-- PERSONAL ACCESS TOKENS
CREATE TABLE IF NOT EXISTS personal_access_tokens (
    id BIGSERIAL PRIMARY KEY,
    tokenable_type VARCHAR(255) NOT NULL,
    tokenable_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    token VARCHAR(64) NOT NULL UNIQUE,
    abilities TEXT,
    last_used_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
CREATE INDEX IF NOT EXISTS personal_access_tokens_tokenable_type_tokenable_id_index ON personal_access_tokens(tokenable_type, tokenable_id);

-- PASSWORD RESET TOKENS
CREATE TABLE password_reset_tokens (
    email VARCHAR(255) PRIMARY KEY,
    token VARCHAR(255),
    created_at TIMESTAMP
);

-- SESSIONS
CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    ip_address VARCHAR(45),
    user_agent TEXT,
    payload TEXT,
    last_activity INTEGER
);

-- =========================
-- ROUTERS
-- =========================
CREATE TABLE routers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    ip_address VARCHAR(45),
    model VARCHAR(255),
    os_version VARCHAR(50),
    last_seen TIMESTAMP,
    port INTEGER DEFAULT 8728,
    username VARCHAR(100) NOT NULL,
    password TEXT NOT NULL,
    location VARCHAR(255),
    status VARCHAR(50) DEFAULT 'pending',
    provisioning_stage VARCHAR(50),
    interface_assignments JSON DEFAULT '[]',
    configurations JSON DEFAULT '[]',
    config_token VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- WIREGUARD
CREATE TABLE wireguard_peers (
    id SERIAL PRIMARY KEY,
    router_id INTEGER REFERENCES routers(id) ON DELETE CASCADE,
    peer_name VARCHAR(255),
    public_key TEXT,
    endpoint VARCHAR(255),
    allowed_ips TEXT,
    last_handshake TIMESTAMP
);

CREATE TABLE router_configs (
    id SERIAL PRIMARY KEY,
    router_id INTEGER REFERENCES routers(id) ON DELETE CASCADE,
    config_type VARCHAR(50) NOT NULL,
    config_data JSON,
    config_content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE router_vpn_configs (
    id SERIAL PRIMARY KEY,
    router_id INTEGER UNIQUE REFERENCES routers(id) ON DELETE CASCADE,
    
    -- WireGuard configuration
    wireguard_public_key VARCHAR(255) UNIQUE NOT NULL,
    wireguard_private_key TEXT,
    vpn_ip_address INET UNIQUE NOT NULL,
    listen_port INTEGER DEFAULT 13231,
    
    -- Connection status
    vpn_connected BOOLEAN DEFAULT FALSE,
    last_handshake TIMESTAMP,
    bytes_received BIGINT DEFAULT 0,
    bytes_sent BIGINT DEFAULT 0,
    
    -- RADIUS configuration
    radius_server_ip INET DEFAULT '10.10.10.1',
    radius_auth_port INTEGER DEFAULT 1812,
    radius_acct_port INTEGER DEFAULT 1813,
    radius_secret VARCHAR(255) NOT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_router_vpn_configs_router_id ON router_vpn_configs(router_id);
CREATE INDEX idx_router_vpn_configs_vpn_connected ON router_vpn_configs(vpn_connected);

-- =========================
-- PACKAGES
-- =========================
CREATE TABLE packages (
    id SERIAL PRIMARY KEY,
    type VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    duration VARCHAR(50) NOT NULL,
    upload_speed VARCHAR(50) NOT NULL,
    download_speed VARCHAR(50) NOT NULL,
    price FLOAT NOT NULL,
    devices INTEGER NOT NULL,
    enable_burst BOOLEAN DEFAULT FALSE,
    enable_schedule BOOLEAN DEFAULT FALSE,
    hide_from_client BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- PAYMENTS & VOUCHERS
-- =========================
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL, -- Link to user (NULL for guest purchases)
    mac_address VARCHAR(17) NOT NULL,
    phone_number VARCHAR(15) NOT NULL,
    package_id INTEGER REFERENCES packages(id) ON DELETE CASCADE,
    router_id INTEGER REFERENCES routers(id) ON DELETE SET NULL,
    amount DECIMAL(10, 2) NOT NULL, -- Payment amount
    transaction_id VARCHAR(255) UNIQUE NOT NULL, -- M-Pesa/External transaction ID
    mpesa_receipt VARCHAR(255), -- M-Pesa receipt number
    status VARCHAR(20) DEFAULT 'pending', -- pending, completed, failed
    payment_method VARCHAR(50) DEFAULT 'mpesa', -- mpesa, cash, account_balance
    callback_response JSON, -- Full M-Pesa callback data
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for payments
CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_phone_number ON payments(phone_number);
CREATE INDEX idx_payments_created_at ON payments(created_at DESC);

-- User subscriptions (active packages)
CREATE TABLE user_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    package_id INTEGER NOT NULL REFERENCES packages(id) ON DELETE CASCADE,
    payment_id INTEGER REFERENCES payments(id) ON DELETE SET NULL,
    mac_address VARCHAR(17) NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'active', -- active, expired, suspended
    mikrotik_username VARCHAR(255), -- Generated username for MikroTik
    mikrotik_password VARCHAR(255), -- Generated password for MikroTik
    data_used_mb BIGINT DEFAULT 0,
    time_used_minutes INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_status ON user_subscriptions(status);

CREATE TABLE vouchers (
    id SERIAL PRIMARY KEY,
    code VARCHAR(255) UNIQUE NOT NULL,
    mac_address VARCHAR(17) NOT NULL,
    payment_id INTEGER NOT NULL REFERENCES payments(id) ON DELETE CASCADE,
    package_id INTEGER NOT NULL REFERENCES packages(id) ON DELETE CASCADE,
    duration_hours INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'unused',
    expires_at TIMESTAMP NOT NULL,
    mikrotik_response JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    payment_id INTEGER REFERENCES payments(id) ON DELETE CASCADE,
    voucher VARCHAR(255) UNIQUE NOT NULL,
    mac_address VARCHAR(17) NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- LOGGING
-- =========================
CREATE TABLE system_logs (
    id SERIAL PRIMARY KEY,
    action VARCHAR(255) NOT NULL,
    details JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- QUEUE TABLES
-- =========================
CREATE TABLE jobs (
    id BIGSERIAL PRIMARY KEY,
    queue VARCHAR(255) NOT NULL,
    payload TEXT NOT NULL,
    attempts SMALLINT NOT NULL,
    reserved_at INTEGER,
    available_at INTEGER NOT NULL,
    created_at INTEGER NOT NULL
);
CREATE INDEX idx_jobs_queue ON jobs(queue);

CREATE TABLE job_batches (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    total_jobs INTEGER NOT NULL,
    pending_jobs INTEGER NOT NULL,
    failed_jobs INTEGER NOT NULL,
    failed_job_ids TEXT NOT NULL,
    options TEXT,
    cancelled_at INTEGER,
    created_at INTEGER NOT NULL,
    finished_at INTEGER
);

CREATE TABLE failed_jobs (
    id BIGSERIAL PRIMARY KEY,
    uuid VARCHAR(255) UNIQUE NOT NULL,
    connection TEXT NOT NULL,
    queue TEXT NOT NULL,
    payload TEXT NOT NULL,
    exception TEXT NOT NULL,
    failed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- SAMPLE DATA
-- =========================
INSERT INTO packages (type, name, duration, upload_speed, download_speed, price, devices, enable_burst, enable_schedule, hide_from_client) VALUES
('Basic', 'Normal 1 Hour', '1 hour', '3 Mbps', '3 Mbps', 1.00, 1, FALSE, FALSE, FALSE),
('Basic', 'Normal 12 Hours', '12 hours', '3 Mbps', '3 Mbps', 20.00, 2, FALSE, FALSE, FALSE),
('Premium', 'High 1 Hour', '1 hour', '10 Mbps', '10 Mbps', 15.00, 1, TRUE, FALSE, FALSE),
('Premium', 'High 12 Hours', '12 hours', '10 Mbps', '10 Mbps', 25.00, 3, TRUE, TRUE, FALSE)
ON CONFLICT DO NOTHING;


-- Insert admin user (role: admin)
INSERT INTO users (name, username, email, password, role, is_active, created_at, updated_at) VALUES 
('System Administrator', 'admin', 'admin@example.com', '$2y$10$exampleHashedPasswordHere', 'admin', TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
ON CONFLICT (username) DO NOTHING;

-- Seed example NAS
INSERT INTO nas (nasname, shortname, type, ports, secret, description)
VALUES ('192.168.88.1', 'mikrotik', 'other', 0, 'testing123', 'MikroTik Router')
ON CONFLICT (nasname) DO NOTHING;

-- =============================================================================
-- HOTSPOT USERS TABLE
-- =============================================================================
-- Stores hotspot user credentials and subscription information
CREATE TABLE IF NOT EXISTS hotspot_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    phone_number VARCHAR(255) UNIQUE NOT NULL,
    mac_address VARCHAR(255),
    
    -- Subscription details
    has_active_subscription BOOLEAN DEFAULT FALSE,
    package_name VARCHAR(255),
    package_id BIGINT,
    subscription_starts_at TIMESTAMP,
    subscription_expires_at TIMESTAMP,
    
    -- Data usage (in bytes)
    data_limit BIGINT,
    data_used BIGINT DEFAULT 0,
    
    -- Login tracking
    last_login_at TIMESTAMP,
    last_login_ip VARCHAR(255),
    
    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    status VARCHAR(50) DEFAULT 'active', -- active, suspended, expired
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    
    -- Foreign key
    CONSTRAINT fk_hotspot_user_package FOREIGN KEY (package_id) 
        REFERENCES packages(id) ON DELETE SET NULL
);

-- Indexes for hotspot_users
CREATE INDEX IF NOT EXISTS idx_hotspot_users_username ON hotspot_users(username);
CREATE INDEX IF NOT EXISTS idx_hotspot_users_phone_number ON hotspot_users(phone_number);
CREATE INDEX IF NOT EXISTS idx_hotspot_users_has_active_subscription ON hotspot_users(has_active_subscription);
CREATE INDEX IF NOT EXISTS idx_hotspot_users_subscription_expires_at ON hotspot_users(subscription_expires_at);
CREATE INDEX IF NOT EXISTS idx_hotspot_users_deleted_at ON hotspot_users(deleted_at);

-- =============================================================================
-- HOTSPOT SESSIONS TABLE
-- =============================================================================
-- Tracks active and historical hotspot user sessions
CREATE TABLE IF NOT EXISTS hotspot_sessions (
    id BIGSERIAL PRIMARY KEY,
    hotspot_user_id BIGINT NOT NULL,
    
    -- Session details
    mac_address VARCHAR(255),
    ip_address VARCHAR(255),
    session_start TIMESTAMP NOT NULL,
    session_end TIMESTAMP,
    last_activity TIMESTAMP,
    expires_at TIMESTAMP,
    
    -- Session status
    is_active BOOLEAN DEFAULT TRUE,
    
    -- Data usage for this session (in bytes)
    bytes_uploaded BIGINT DEFAULT 0,
    bytes_downloaded BIGINT DEFAULT 0,
    total_bytes BIGINT DEFAULT 0,
    
    -- Connection details
    user_agent VARCHAR(500),
    device_type VARCHAR(100),
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Foreign key
    CONSTRAINT fk_hotspot_session_user FOREIGN KEY (hotspot_user_id) 
        REFERENCES hotspot_users(id) ON DELETE CASCADE
);

-- Indexes for hotspot_sessions
CREATE INDEX IF NOT EXISTS idx_hotspot_sessions_user_id ON hotspot_sessions(hotspot_user_id);
CREATE INDEX IF NOT EXISTS idx_hotspot_sessions_is_active ON hotspot_sessions(is_active);
CREATE INDEX IF NOT EXISTS idx_hotspot_sessions_session_start ON hotspot_sessions(session_start);
CREATE INDEX IF NOT EXISTS idx_hotspot_sessions_expires_at ON hotspot_sessions(expires_at);
CREATE INDEX IF NOT EXISTS idx_hotspot_sessions_mac_address ON hotspot_sessions(mac_address);

-- =============================================================================
-- SEED DATA FOR HOTSPOT USERS (Test Users)
-- =============================================================================
-- Insert test hotspot user
INSERT INTO hotspot_users (
    username, 
    password, 
    phone_number, 
    mac_address,
    has_active_subscription,
    package_name,
    subscription_starts_at,
    subscription_expires_at,
    data_limit,
    data_used,
    is_active,
    status,
    created_at,
    updated_at
) VALUES (
    'testuser',
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- password: password
    '+254712345678',
    'D6:D2:52:1C:90:71',
    TRUE,
    'Normal 1 Hour',
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP + INTERVAL '24 hours',
    1073741824, -- 1GB in bytes
    0,
    TRUE,
    'active',
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
) ON CONFLICT (username) DO NOTHING;

-- Insert another test user with expired subscription
INSERT INTO hotspot_users (
    username, 
    password, 
    phone_number,
    has_active_subscription,
    package_name,
    subscription_starts_at,
    subscription_expires_at,
    data_limit,
    data_used,
    is_active,
    status,
    created_at,
    updated_at
) VALUES (
    'expireduser',
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- password: password
    '+254712345679',
    FALSE,
    'Normal 1 Hour',
    CURRENT_TIMESTAMP - INTERVAL '2 days',
    CURRENT_TIMESTAMP - INTERVAL '1 day',
    1073741824,
    0,
    TRUE,
    'expired',
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
) ON CONFLICT (username) DO NOTHING;

-- =============================================================================
-- COMMENTS FOR DOCUMENTATION
-- =============================================================================
COMMENT ON TABLE hotspot_users IS 'Stores hotspot user credentials and subscription information';
COMMENT ON TABLE hotspot_sessions IS 'Tracks active and historical hotspot user sessions';

COMMENT ON COLUMN hotspot_users.data_limit IS 'Data limit in bytes (e.g., 1073741824 = 1GB)';
COMMENT ON COLUMN hotspot_users.data_used IS 'Total data used in bytes';
COMMENT ON COLUMN hotspot_users.status IS 'User status: active, suspended, or expired';

COMMENT ON COLUMN hotspot_sessions.bytes_uploaded IS 'Total bytes uploaded in this session';
COMMENT ON COLUMN hotspot_sessions.bytes_downloaded IS 'Total bytes downloaded in this session';
COMMENT ON COLUMN hotspot_sessions.total_bytes IS 'Total bytes transferred in this session';

-- =============================================================================
-- TRIGGERS FOR UPDATED_AT TIMESTAMPS
-- =============================================================================
-- Trigger for hotspot_users updated_at
CREATE OR REPLACE FUNCTION update_hotspot_users_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_hotspot_users_updated_at
    BEFORE UPDATE ON hotspot_users
    FOR EACH ROW
    EXECUTE FUNCTION update_hotspot_users_updated_at();

-- Trigger for hotspot_sessions updated_at
CREATE OR REPLACE FUNCTION update_hotspot_sessions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_hotspot_sessions_updated_at
    BEFORE UPDATE ON hotspot_sessions
    FOR EACH ROW
    EXECUTE FUNCTION update_hotspot_sessions_updated_at();

-- =============================================================================
-- RADIUS SESSIONS TABLE (Enhanced Session Tracking)
-- =============================================================================
CREATE TABLE IF NOT EXISTS radius_sessions (
    id BIGSERIAL PRIMARY KEY,
    hotspot_user_id BIGINT REFERENCES hotspot_users(id) ON DELETE CASCADE,
    payment_id BIGINT REFERENCES payments(id) ON DELETE SET NULL,
    package_id BIGINT REFERENCES packages(id) ON DELETE SET NULL,
    
    -- RADIUS data
    radacct_id BIGINT,
    username VARCHAR(64) NOT NULL,
    mac_address VARCHAR(17),
    ip_address INET,
    nas_ip_address INET,
    
    -- Session timing
    session_start TIMESTAMP NOT NULL,
    session_end TIMESTAMP,
    expected_end TIMESTAMP NOT NULL,
    duration_seconds BIGINT DEFAULT 0,
    
    -- Data usage
    bytes_in BIGINT DEFAULT 0,
    bytes_out BIGINT DEFAULT 0,
    total_bytes BIGINT DEFAULT 0,
    
    -- Status
    status VARCHAR(20) DEFAULT 'active', -- active, expired, disconnected
    disconnect_reason VARCHAR(100),
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_radius_sessions_hotspot_user ON radius_sessions(hotspot_user_id);
CREATE INDEX IF NOT EXISTS idx_radius_sessions_status ON radius_sessions(status);
CREATE INDEX IF NOT EXISTS idx_radius_sessions_expected_end ON radius_sessions(expected_end);
CREATE INDEX IF NOT EXISTS idx_radius_sessions_username ON radius_sessions(username);

COMMENT ON TABLE radius_sessions IS 'Enhanced session tracking linking hotspot users with RADIUS accounting';

-- =============================================================================
-- HOTSPOT CREDENTIALS TABLE (SMS Delivery Tracking)
-- =============================================================================
CREATE TABLE IF NOT EXISTS hotspot_credentials (
    id BIGSERIAL PRIMARY KEY,
    hotspot_user_id BIGINT REFERENCES hotspot_users(id) ON DELETE CASCADE,
    payment_id BIGINT REFERENCES payments(id) ON DELETE SET NULL,
    
    -- Credentials
    username VARCHAR(64) NOT NULL,
    plain_password VARCHAR(64) NOT NULL,
    
    -- SMS delivery
    phone_number VARCHAR(20) NOT NULL,
    sms_sent BOOLEAN DEFAULT FALSE,
    sms_sent_at TIMESTAMP,
    sms_message_id VARCHAR(100),
    sms_status VARCHAR(50),
    
    -- Expiry
    credentials_expires_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_hotspot_credentials_user ON hotspot_credentials(hotspot_user_id);
CREATE INDEX IF NOT EXISTS idx_hotspot_credentials_phone ON hotspot_credentials(phone_number);
CREATE INDEX IF NOT EXISTS idx_hotspot_credentials_sms_sent ON hotspot_credentials(sms_sent);

COMMENT ON TABLE hotspot_credentials IS 'Temporary storage of credentials for SMS delivery tracking';

-- =============================================================================
-- SESSION DISCONNECTIONS TABLE (Disconnection Tracking)
-- =============================================================================
CREATE TABLE IF NOT EXISTS session_disconnections (
    id BIGSERIAL PRIMARY KEY,
    radius_session_id BIGINT REFERENCES radius_sessions(id) ON DELETE CASCADE,
    hotspot_user_id BIGINT REFERENCES hotspot_users(id) ON DELETE CASCADE,
    
    -- Disconnection details
    disconnect_method VARCHAR(50), -- auto_expire, admin_disconnect, user_logout
    disconnect_reason VARCHAR(255),
    disconnected_at TIMESTAMP NOT NULL,
    disconnected_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    
    -- Session summary
    total_duration BIGINT,
    total_data_used BIGINT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_session_disconnections_user ON session_disconnections(hotspot_user_id);
CREATE INDEX IF NOT EXISTS idx_session_disconnections_date ON session_disconnections(disconnected_at);
CREATE INDEX IF NOT EXISTS idx_session_disconnections_method ON session_disconnections(disconnect_method);

COMMENT ON TABLE session_disconnections IS 'Audit log of all session disconnections';

-- =============================================================================
-- DATA USAGE LOGS TABLE (Detailed Data Tracking)
-- =============================================================================
CREATE TABLE IF NOT EXISTS data_usage_logs (
    id BIGSERIAL PRIMARY KEY,
    hotspot_user_id BIGINT REFERENCES hotspot_users(id) ON DELETE CASCADE,
    radius_session_id BIGINT REFERENCES radius_sessions(id) ON DELETE CASCADE,
    
    -- Usage data
    bytes_in BIGINT NOT NULL,
    bytes_out BIGINT NOT NULL,
    total_bytes BIGINT NOT NULL,
    
    -- Snapshot time
    recorded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- Source
    source VARCHAR(50) DEFAULT 'radius_accounting'
);

CREATE INDEX IF NOT EXISTS idx_data_usage_logs_user ON data_usage_logs(hotspot_user_id);
CREATE INDEX IF NOT EXISTS idx_data_usage_logs_session ON data_usage_logs(radius_session_id);
CREATE INDEX IF NOT EXISTS idx_data_usage_logs_date ON data_usage_logs(recorded_at);

COMMENT ON TABLE data_usage_logs IS 'Time-series data usage tracking for analytics';

-- =============================================================================
-- TRIGGERS FOR NEW TABLES
-- =============================================================================
CREATE OR REPLACE FUNCTION update_radius_sessions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_radius_sessions_updated_at
    BEFORE UPDATE ON radius_sessions
    FOR EACH ROW
    EXECUTE FUNCTION update_radius_sessions_updated_at();